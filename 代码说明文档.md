# 翼型逆向设计系统 - 代码说明文档

## 项目概述

### 项目目的
本项目实现了一个**基于深度学习的翼型逆向设计系统**，能够根据目标升力系数（CL）和阻力系数（CD）自动生成满足性能要求的翼型几何形状。

### 核心功能
- **数据收集与预处理**：从UIUC数据库下载并处理翼型数据
- **翼型生成**：使用DCGAN（深度卷积生成对抗网络）生成新的翼型图像
- **性能预测**：使用CNN回归模型预测翼型的升阻力系数
- **逆向设计**：在潜在空间中优化搜索，生成满足目标CL/CD的翼型

### 工作流程
```
1. 数据获取 → 2. 图像生成 → 3. 坐标转换 → 4. CFD仿真 → 5. 性能预测 → 6. 逆向设计
```

---

## 代码文件分类

### 1. 数据获取与预处理类
- `Airfoildata_get.py` - UIUC翼型数据下载
- `Airfoil_graph.py` - 翼型图像生成与处理
- `bezier_spline.py` - 翼型坐标平滑处理

### 2. 数据分析类
- `Data_Distribution.py` - 数据分布分析
- `Data_Quality_Assessment.py` - 数据质量评估
- `analyze_cd_issue.py` - CD值问题分析
- `diagnose_cd_issue.py` - CD预测问题诊断

### 3. 深度学习模型训练类
- `DCGAN_train_contour.py` - DCGAN训练（轮廓图像）
- `DCGAN_train_filled.py` - DCGAN训练（填充图像）
- `cnn_regression.py` - CNN回归模型训练
- `cnn_evaluate_model.py` - CNN模型评估

### 4. 仿真与数据处理类
- `simulation.py` - 翼型气动性能仿真
- `inverse_y.py` - Y坐标翻转处理

### 5. 逆向设计类
- `inverse_design.py` - 基于梯度下降的逆向设计
- `inverse_design_GA.py` - 基于遗传算法的逆向设计
---

## 详细代码说明

### 1. Airfoildata_get.py

**功能**：从UIUC翼型数据库中下载翼型坐标数据文件（.dat格式）

**主要函数**：
- `download_all_airfoils(base_url, output_dir)`: 下载所有翼型数据文件
- `validate_downloaded_files(directory)`: 验证下载的文件

**使用示例**：
```python
python Airfoildata_get.py
```

**输出**：
- `UIUC_airfoils/` 目录下保存所有下载的.dat文件

---

### 2. Airfoil_graph.py

**功能**：将翼型坐标文件转换为图像，支持多种图像格式（轮廓、填充、SDF）

**主要函数**：
- `read_airfoil_data(filename)`: 读取翼型坐标文件
- `create_proportional_airfoil_image(coords, ...)`: 创建等比例轮廓图像
- `create_proportional_filled_airfoil_image(coords, ...)`: 创建填充图像
- `generate_proportional_airfoil_images()`: 批量生成图像

**使用示例**：
```python
python Airfoil_graph.py
```

**输出**：
- `airfoil_images/contour_proportional/` - 轮廓图像
- `airfoil_images/filled_proportional/` - 填充图像
- `airfoil_images/sdf_proportional/` - SDF图像

---

### 3. bezier_spline.py

**功能**：对翼型坐标进行B样条平滑处理，标准化翼型格式

**主要功能**：
- 坐标归一化（弦长归一化到1.0）
- 旋转对齐（前缘到后缘对齐x轴）
- B样条平滑
- 上下表面分离和排序

**使用示例**：
```python
python bezier_spline.py
```

**输入**：`DCGAN_result/airfoil_coordinates/*.dat`
**输出**：`DCGAN_result/airfoil_coordinates/normalization/*.dat`

---

### 4. Data_Distribution.py

**功能**：分析翼型数据集的统计分布特征

**分析内容**：
- CL、CD、L/D的分布统计
- 直方图、箱线图、散点图
- 相关性矩阵
- 核密度估计

**使用示例**：
```python
python Data_Distribution.py
```

**输入**：`DCGAN_result/generated_airfoils/labels.csv`
**输出**：
- `airfoil_analysis.png` - 综合分析图
- `airfoil_distribution_analysis.png` - 分布分析图
- `statistics_summary.csv` - 统计摘要

---

### 5. Data_Quality_Assessment.py

**功能**：全面评估数据集质量，生成质量评估报告

**评估维度**：
1. **完整性**：缺失数据率、样本数量
2. **有效性**：无效值（NaN、Inf）比例
3. **一致性**：变异系数（CV）
4. **异常值**：使用IQR方法检测
5. **物理合理性**：负值检查、合理范围检查
6. **分布特征**：偏度、峰度
7. **相关性**：Pearson相关系数
8. **性能多样性**：高性能样本比例

**使用示例**：
```python
python Data_Quality_Assessment.py
```

**输出**：
- `data_quality_report.csv` - 详细质量报告
- `data_quality_assessment.png` - 可视化报告
- 控制台输出总体质量分数（0-100）

**质量评级**：
- EXCELLENT (90-100): 高质量数据集
- GOOD (75-89): 良好质量
- FAIR (60-74): 可接受但需改进
- POOR (<60): 需要清理

---

### 6. DCGAN_train_contour.py

**功能**：训练DCGAN模型生成翼型轮廓图像

**模型架构**：
- **生成器**：6层转置卷积，输入100维潜在向量，输出128×128灰度图像
- **判别器**：4层卷积，输出真/假判断

**训练特性**：
- Feature Matching损失：提高生成质量
- Smoothness损失：确保生成图像平滑
- 学习率调度：余弦退火
- GPU加速支持

**使用示例**：
```python
python DCGAN_train_contour.py
```

**配置参数**：
- `EPOCHS = 300` - 训练轮数
- `BATCH_SIZE = 32` - 批次大小
- `LATENT_DIM = 100` - 潜在空间维度

**输出**：
- `DCGAN_result/airfoil_generator_final.pth` - 生成器模型
- `DCGAN_result/airfoil_discriminator_final.pth` - 判别器模型
- `DCGAN_result/generated_images_epoch_*.png` - 训练过程生成的样本

---

### 7. DCGAN_train_filled.py

**功能**：训练DCGAN模型生成填充的翼型图像（与轮廓版本类似，但训练数据不同）

**区别**：
- 使用填充图像作为训练数据
- 生成后可直接提取轮廓坐标
- 适合需要完整翼型形状的应用

**使用示例**：
```python
python DCGAN_train_filled.py
```

**输出**：
- 模型文件
- 生成的填充图像
- 轮廓坐标文件（`airfoil_coordinates/`）

---

### 8. cnn_regression.py

**功能**：训练CNN回归模型，从翼型图像预测CL和CD

**模型架构**：
- 4层卷积特征提取器
- 全连接回归器（512→128→2）
- 支持标签标准化（`--standardize_labels`）

**训练特性**：
- 加权MSE损失（可调整CL/CD权重）
- 数据增强
- 验证集评估
- 模型检查点保存

**使用示例**：
```bash
# 基本训练
python cnn_regression.py --data_dir DCGAN_result/generated_airfoils --labels Simulation/labels.csv

# 使用标签标准化（推荐，特别是CD方差较小时）
python cnn_regression.py --standardize_labels --cd_weight 100.0
```

**主要参数**：
- `--data_dir`: 图像数据目录
- `--labels`: 标签CSV文件路径
- `--batch_size`: 批次大小（默认64）
- `--epochs`: 训练轮数（默认50）
- `--cd_weight`: CD损失的权重（默认100.0，因为CD数值较小）
- `--standardize_labels`: 使用标签标准化

**输出**：
- `runs/cnn_regression/best_model.pth` - 最佳模型
- `runs/cnn_regression/val_predictions.csv` - 验证集预测结果

---

### 9. cnn_evaluate_model.py

**功能**：评估训练好的CNN回归模型性能

**评估指标**：
- MAE (Mean Absolute Error)
- RMSE (Root Mean Square Error)
- R² (决定系数)

**使用示例**：
```bash
python cnn_evaluate_model.py --predictions_csv runs/cnn_regression/val_predictions.csv
```

**输出**：
- `cl_predictions.png` - CL预测散点图
- `cd_predictions.png` - CD预测散点图
- `metrics.csv` - 评估指标表

---

### 10. simulation.py

**功能**：基于几何参数计算翼型的气动性能（简化的解析模型）

**计算内容**：
- 最大厚度和最大弯度
- 升力系数（CL）- 基于薄翼理论
- 阻力系数（CD）- 粘性阻力 + 波阻 + 诱导阻力
- 升阻比（L/D）

**使用示例**：
```python
python simulation.py
```

**输入**：`DCGAN_result/airfoil_coordinates/Analysis/*.dat`
**输出**：
- `Simulation/results.json` - JSON格式结果
- `Simulation/labels.csv` - CSV格式标签（用于模型训练）

**仿真参数**：
- 雷诺数：Re = 1.8×10⁶
- 马赫数：Ma = 0.01
- 攻角：α = 0°

---
### 11. inverse_y.py

**功能**：将翼型坐标的Y坐标翻转（用于坐标系统转换）

**使用示例**：
```python
python inverse_y.py
```

**输入**：`DCGAN_result/airfoil_coordinates/normalization/*.dat`
**输出**：`DCGAN_result/airfoil_coordinates/Analysis/*.dat`

---

### 12. inverse_design.py

**功能**：基于梯度下降的逆向设计系统（核心文件）

**工作原理**：
1. 加载训练好的DCGAN生成器和CNN预测器
2. 在潜在空间中初始化随机向量
3. 使用梯度下降优化潜在向量
4. 优化目标：最小化预测CL/CD与目标CL/CD的差异
5. 多次重启避免局部最优

**使用示例**：
```bash
# 基本使用
python inverse_design.py --target_cl 0.8 --target_cd 0.02

# 完整参数示例
python inverse_design.py \
    --target_cl 0.8 \
    --target_cd 0.02 \
    --tolerance_cl 0.05 \
    --tolerance_cd 0.005 \
    --cl_weight 2.0 \
    --cd_weight 1.0 \
    --max_iter 500 \
    --num_restarts 5 \
    --lr 0.1 \
    --two_stage \
    --auto_adjust
```

**主要参数**：
- `--target_cl`: 目标升力系数（必需）
- `--target_cd`: 目标阻力系数（必需）
- `--max_iter`: 最大迭代次数（默认500）
- `--num_restarts`: 重启次数（默认5）
- `--cl_weight`: CL权重（默认2.0）
- `--cd_weight`: CD权重（默认1.0）
- `--two_stage`: 使用两阶段优化（先优化CL，再优化两者）
- `--use_relative_error`: 使用相对误差
- `--auto_adjust`: 自动调整超出数据范围的目标值

**输出**：
- `airfoil_cl{target_cl}_cd{target_cd}.png` - 生成的翼型图像
- `design_result_cl{target_cl}_cd{target_cd}.png` - 设计结果图
- `latent_vector_cl{target_cl}_cd{target_cd}.npy` - 优化得到的潜在向量

---

### 13. inverse_design_GA.py

**功能**：基于遗传算法（GA）的逆向设计系统

**算法特点**：
- 使用遗传算法在潜在空间中搜索
- 支持选择、交叉、变异操作
- 精英保留策略
- 适合多模态优化问题

**使用示例**：
```bash
python inverse_design_GA.py \
    --target_cl 0.8 \
    --target_cd 0.02 \
    --max_generations 100 \
    --population_size 50 \
    --mutation_rate 0.1 \
    --crossover_rate 0.8
```

**GA参数**：
- `--max_generations`: 最大进化代数（默认100）
- `--population_size`: 种群大小（默认50）
- `--mutation_rate`: 变异率（默认0.1）
- `--crossover_rate`: 交叉率（默认0.8）
- `--elite_ratio`: 精英比例（默认0.1）

**适用场景**：
- 目标函数存在多个局部最优
- 需要探索更大的设计空间
- 对收敛性要求较高的场景

---

### 14. analyze_cd_issue.py

**功能**：分析数据集中CD值的分布特征，识别可能的问题

**分析内容**：
- CD统计信息
- 目标CD值的样本数量
- CL和CD的关系

**使用示例**：
```python
python analyze_cd_issue.py
```

**输出**：
- 控制台输出统计分析
- `cd_analysis.png` - CD分布和散点图

---

### 15. diagnose_cd_issue.py

**功能**：诊断CNN模型在CD预测上的问题

**诊断内容**：
- 预测CD的方差分析
- CD预测误差分析
- 与CL预测的对比
- 标准化建议

**使用示例**：
```python
python diagnose_cd_issue.py
```

**输出**：
- 控制台输出诊断报告
- 如果CD预测方差过小，建议使用`--standardize_labels`标志重新训练

---

## 🔄 完整工作流程

### 第一步：数据收集与预处理
```bash
# 1. 下载UIUC翼型数据
python Airfoildata_get.py

# 2. 将坐标转换为图像
python Airfoil_graph.py
```

### 第二步：训练生成模型
```bash
# 3. 训练DCGAN生成器
python DCGAN_train_filled.py

# 4. 生成新翼型（使用训练好的模型）
# （在DCGAN_train_filled.py中自动完成）
```

### 第三步：获取性能标签
```bash
# 5. 转换图像为坐标
# （在DCGAN_train_filled.py中自动完成）

# 6. 坐标平滑处理
python bezier_spline.py

# 7. Y坐标翻转（如需要）
python inverse_y.py

# 8. 计算气动性能
python simulation.py
```

### 第四步：训练预测模型
```bash
# 9. 评估数据质量
python Data_Quality_Assessment.py

# 10. 训练CNN回归模型
python cnn_regression.py --standardize_labels

# 11. 评估模型性能
python cnn_evaluate_model.py
```

### 第五步：逆向设计
```bash
# 12. 使用梯度下降进行逆向设计
python inverse_design.py --target_cl 0.8 --target_cd 0.02

# 或使用遗传算法
python inverse_design_GA.py --target_cl 0.8 --target_cd 0.02
```

---

## 📊 项目依赖

### 核心依赖
- `torch` - PyTorch深度学习框架
- `numpy` - 数值计算
- `pandas` - 数据处理
- `matplotlib` - 数据可视化
- `opencv-python` (cv2) - 图像处理
- `scipy` - 科学计算
- `scikit-learn` - 机器学习工具
- `PIL` (Pillow) - 图像处理

### 可选依赖
- `tqdm` - 进度条显示
- `psutil` - 系统信息

### 安装命令
```bash
pip install torch numpy pandas matplotlib opencv-python scipy scikit-learn pillow tqdm psutil
```

---

## ⚙️ 配置文件说明

### 主要路径配置
项目中的路径配置主要在代码中硬编码，主要路径包括：
- `UIUC_airfoils/` - UIUC翼型数据
- `Standard_airfoil/` - 标准化翼型数据
- `Images_airfoil/` - 翼型图像
- `DCGAN_result/` - DCGAN训练结果
- `Simulation/` - 仿真结果
- `runs/cnn_regression/` - CNN训练结果
- `inverse_design_results/` - 逆向设计结果

---

## 🎯 使用建议

### 1. 数据质量检查
在训练模型前，务必运行数据质量评估：
```bash
python Data_Quality_Assessment.py
```
确保数据质量评分 > 75分

### 2. 模型训练顺序
1. 先训练DCGAN（生成模型）
2. 生成大量翼型样本
3. 获取性能标签
4. 再训练CNN（预测模型）
5. 最后进行逆向设计

### 3. 逆向设计参数调优
- **目标值范围**：确保在训练数据范围内
- **权重调整**：如果CL/CD精度不平衡，调整`cl_weight`和`cd_weight`
- **迭代次数**：`max_iter=500`通常是较好的平衡点
- **重启次数**：`num_restarts=5-10`通常足够

### 4. 性能优化
- 使用GPU加速（`--device cuda`）
- 批次大小根据显存调整
- 使用标签标准化提高CD预测精度

---

## 🐛 常见问题

### 问题1：CD预测精度低
**解决方案**：
- 使用`--standardize_labels`标志训练CNN
- 增加CD损失的权重（`--cd_weight 100.0`）
- 检查数据质量（运行`diagnose_cd_issue.py`）

### 问题2：逆向设计不收敛
**解决方案**：
- 增加迭代次数（`--max_iter 500`）
- 增加重启次数（`--num_restarts 10`）
- 检查目标值是否在合理范围内
- 尝试使用遗传算法（`inverse_design_GA.py`）

### 问题3：生成翼型质量差
**解决方案**：
- 增加DCGAN训练轮数
- 检查训练数据质量
- 使用特征匹配和平滑损失

---
## 📧 联系方式

如有问题或建议，请查看项目文档或联系项目维护者。
jzhongau@connect.ust.hk